## Paxos/Raft: (Generalize): å…è®¸æœªå‘ç”Ÿäº‹ä»¶çš„æ—¶é—´å›é€€

**Paxos ä¸­çš„ `last_rnd` æ˜¯å…è®¸å›é€€çš„**: è™½ç„¶ Paxos ä¸­å®šä¹‰ `last_rnd`  ä¸ºå•è°ƒå¢: å¦‚æœ acceptor åœ¨ `phase-1` æˆ– `phase-2` æ”¶åˆ°æ›´å¤§çš„ `rnd`, åˆ™ç”¨å®ƒè¦†ç›–è‡ªå·±çš„ `last_rnd`. **ä½† `last_rnd` å®é™…ä¸Šå¯ä»¥åœ¨ä¿è¯æ­£ç¡®æ€§çš„å‰æä¸‹æ”¯æŒå›é€€**: å¦‚æœ proposer åœ¨ `phase-1` å°† acceptor çš„ `last_rnd` ä» 1 æå‡åˆ° 2,
é‚£ä¹ˆåªè¦æ²¡è¿›å…¥ `phase-2`, proposer éƒ½å¯ä»¥å†å‘é€ä¸€ä¸ª `phase-1-revert` æ¶ˆæ¯è¦æ±‚ acceptor å°† `last_rnd` ä» 2 å›é€€åˆ° 1; è€Œ acceptor çš„ `last_rnd` å¦‚æœè¿˜æ˜¯ 2, å°±å¯ä»¥è¿›è¡Œå›é€€.

**Revert çš„æ­£ç¡®æ€§** å®¹æ˜“ç›´è§‚çš„çœ‹å‡º: revert å¯ä»¥çœ‹ä½œä¸€ä¸ªäººä¸ºåˆ¶é€ çš„**ä¸¢æ¶ˆæ¯**çš„äº‹ä»¶, è€Œ Paxos æœ¬èº«åˆæ˜¯å…è®¸ä¸¢æ¶ˆæ¯è€Œä¸ç ´åä¸€è‡´æ€§çš„.

**ä¸¾ä¸ª revert æ“ä½œçš„æ —å­**: å‡è®¾å½“å‰ P1, P2, P3 åˆ†åˆ«ç”¨ `rnd`=1,2,3 æ‰§è¡Œäº† phase-1: é‚£ä¹ˆ:
å¯ä»¥æ‰§è¡Œçš„revertæ“ä½œæ˜¯:

A1 âœ… å…è®¸ P3: `1 â† 3`

A2 âœ… å…è®¸ P3: `2 â† 3`, âœ… ç„¶åå…è®¸ P2: `1 â† 2`; âŒ ä½†æ˜¯ä¸å…è®¸: `1 â† 3`.

![](paxos-revert-rnd-margin.jpeg)


Revert å¯ä»¥åº”ç”¨åˆ° Paxos(å°† acceptor çš„ `last_rnd` å›é€€åˆ°ä¸Šä¸€ä¸ªå€¼), ä¹Ÿå¯ä»¥åº”ç”¨åˆ° raft(å°† `(term, voted_for)` å›é€€åˆ°ä¸Šä¸€ä¸ªå€¼).
ğŸ’¡ Tip: Paxos çš„ `last_rnd` ç­‰åŒäº raft çš„ `(term, voted_for)`, åˆ†åˆ«ç”¨äºå®šä¹‰è¿™2ä¸ªç³»ç»Ÿä¸­çš„è™šæ‹Ÿ **æ—¶é—´**, è€Œ Paxos ä¸­ `phase-2` å’Œ raft ä¸­çš„ `append` æ—¥å¿—, å¯ä»¥çœ‹åšåœ¨æŸä¸ª **æ—¶é—´ç‚¹** ä¸Šäº§ç”Ÿä¸€ä¸ª **äº‹ä»¶**.

**Revert çš„ç”¨é€”** æ˜¯å¯ä»¥ä¼˜é›…çš„å¤„ç†ä¸€è‡´æ€§åè®®ä¸­ [ååºå…³ç³»](https://zh.wikipedia.org/wiki/ååºå…³ç³») äº§ç”Ÿçš„å†²çª.
ä¾‹å¦‚åœ¨ä¸‹å›¾çš„ raft çŠ¶æ€ä¸­, Follower N3 æ²¡æœ‰æ”¶åˆ°ä»»ä½• term=2 çš„æ—¥å¿—, å¼€å§‹äº† election,
term=3 æ—¶, N1 å’Œ N2 éƒ½ä¼šæ‹’ç» N3 çš„ vote è¯·æ±‚, å› ä¸º N3 çš„ log ä¸å¤Ÿå¤§.
è¿™æ—¶ N1 çš„ Leadership è™½ç„¶ä¸ä¼šä¸¢å¤±, ä½†å·²ç»æ— æ³•å‘ N3 å¤åˆ¶æ—¥å¿—äº†, å› ä¸º N3 çš„ term æ›´å¤§,
N1 å¿…é¡»é€€å‡º Leader åˆ° Candidate é‡æ–°ç”¨æ›´å¤§çš„ term(è‡³å°‘æ˜¯3) æ¥é€‰ä¸¾(raft ä½¿ç”¨ pre-vote æ¥ä¸€å®šç¨‹åº¦ä¸Šé¿å…è¿™ä¸ªé—®é¢˜), é€ æˆçŸ­æš‚çš„ä¸å¯ç”¨.

å¦‚æœä½¿ç”¨ revert, N3 å¯ä»¥åœ¨ election å¤±è´¥å, ä¼˜é›…çš„å°† term å›é€€, ä»è€Œä¸ä¼šæ‰“æ–­æ•´ä¸ªé›†ç¾¤çš„ Leader.

![](paxos-revert-rnd-raft-margin.jpeg)
