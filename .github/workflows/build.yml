name: build README.md
on: [push]
jobs:
  md2zhihu:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - uses: drmingdrmer/md2zhihu@main

      env:
        GITHUB_USERNAME: ${{ github.repository_owner }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        output_dir: .
        target_platform: github
        # disable push for md2zhihu
        output_branch: ""
        pattern: >
            src/README.md
            src/CN.md

    - name: build TOC
      shell: bash
      run: |
        npm install -g --verbose doctoc
        make toc

    - name: commit and push
      shell: bash
      run: |
        git add ./README.md
        git add ./CN.md

        changes="$(git diff --stat --cached | head -n1)"

        git \
          -c "user.name=drmingdrmer" \
          -c "user.email=drdr.xp@gmail.com" \
          commit \
          --allow-empty \
          -m "CI: build README: $changes"

        git push -f origin HEAD:${{ github.ref }}-md2zhihu
